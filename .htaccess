#############################################
# Safer .htaccess: protect sensitive files & folders
# - Allow static assets (js/css) to be served publicly
# - Block direct access to PHP files inside sensitive directories
# - Deny access to .sql/.env and dotfiles
# - Keep API/admin rewrite mappings
#############################################

# Ensure rewrite engine is available for route mappings
<IfModule mod_rewrite.c>
        RewriteEngine On
        RewriteBase /

        # Block direct access to PHP files under these sensitive directories
        RewriteRule ^(config|includes|models)/.*\.php$ - [F,L,NC]

        # Keep API rewrite mappings
        RewriteRule ^api/products$ api/products.php [L,QSA]
        RewriteRule ^api/products/(.*)$ api/products.php/$1 [L,QSA]
        RewriteRule ^api/auth$ api/auth.php [L,QSA]
        RewriteRule ^api/auth/(.*)$ api/auth.php/$1 [L,QSA]
        RewriteRule ^api/uploads$ api/upload.php [L,QSA]

        # Admin route proxies
        RewriteRule ^admin/login$ api/auth.php/login [L,QSA]
        RewriteRule ^admin/logout$ api/auth.php/logout [L,QSA]
        RewriteRule ^admin/status$ api/auth.php/status [L,QSA]
        RewriteRule ^admin/csrf-token$ api/auth.php/csrf-token [L,QSA]
</IfModule>

    # Custom friendly error page for forbidden access
    ErrorDocument 403 /forbidden.html

# Deny access to SQL, env and other sensitive file types
<FilesMatch "\.(sql|env|env\.dist)$">
    <IfModule mod_authz_core.c>
        Require all denied
    </IfModule>
    <IfModule !mod_authz_core.c>
        Deny from all
    </IfModule>
</FilesMatch>

# Protect dotfiles (e.g., .env, .git) â€” deny all
<FilesMatch "^\.">
    <IfModule mod_authz_core.c>
        Require all denied
    </IfModule>
    <IfModule !mod_authz_core.c>
        Order allow,deny
        Deny from all
    </IfModule>
</FilesMatch>

# Prevent directory listing
Options -Indexes

# Set default charset
AddDefaultCharset UTF-8

# PHP settings
<IfModule mod_php.c>
        php_value upload_max_filesize 10M
        php_value post_max_size 10M
        php_value max_execution_time 30
</IfModule>
